name: Update Changelog

on:
  pull_request:
    types: [ closed ]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0.3
      - uses: actions/checkout@v2
      - name: "Generate, commit, and push release changelog"
        id: changelog-generation
        run: |
          gem install github_changelog_generator
          github_changelog_generator \
            --token "$GITHUB_TOKEN" \
            --simple-list \
            --no-issues \
            --pr-label="" \
            --usernames-as-github-logins \
            --front-matter="{ \"layout\": \"default\", \"title\": \"Changelog\" }" \
            --since-tag v2.48.0 \
            --base docs/CHANGELOG_HISTORY.md > docs/CHANGELOG.md
      - name: "Configure Git identity"
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      - name: "Commit and push updated changelog"
        run: |
          git add docs/CHANGELOG.md
          git commit -m "Generate updated changelog"
          git push
